C51 COMPILER V9.60.0.0   BUSCTRL                                                           06/18/2021 17:32:19 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE BUSCTRL
OBJECT MODULE PLACED IN .\OBJ\BusCtrl.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE BusCtrl.c LARGE OPTIMIZE(9,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\OBJ\
                    -BusCtrl.lst) TABS(2) OBJECT(.\OBJ\BusCtrl.obj)

line level    source

   1          //  **************************************************************************
   2          //
   3          //       Copyright (c) 1992-2006 Professonal Computer Technology Co., Ltd
   4          //
   5          //      All rights are reserved. Reproduction in whole or in parts is
   6          //  prohibited without the prior written consent of the copyright owner.
   7          //  --------------------------------------------------------------------------
   8          //
   9          //  Module: BUSCTRL.C
  10          //
  11          //  Purpose: Implementation of BUSCTRL.
  12          //
  13          //  Version: 0.01                                   2006/10/22 10:39¤U¤È
  14          //
  15          //  Compiler: Keil 8051 C Compiler v7.2
  16          //
  17          //  Reference:
  18          //
  19          //
  20          //
  21          //  --------------------------------------------------------------------------
  22          //  Modification:
  23          //
  24          //  R0.01 2006/10/22 10:39¤U¤È Phoenix Chuang
  25          //  Reason:
  26          //    1. Original.
  27          //  Solution:
  28          //  
  29          //  **************************************************************************
  30          //  -----------------------------------
  31          //      Header Files
  32          //  ----------------------------------- 
  33          #include "Types.h"
  34          #include "BusCtrl.h"
  35          
  36          #include "Printf.h"
  37          
  38          //  ------------------------------------
  39          //      Macro Definitions
  40          //  ------------------------------------ 
  41          
  42          
  43          //  ------------------------------------
  44          //      Type Definitions
  45          //  ------------------------------------
  46          
  47          
  48          //  ------------------------------------
  49          //      Variables Definitions
  50          //  ------------------------------------
  51          
  52          
  53          //  ------------------------------------
  54          //      Function Prototypes
C51 COMPILER V9.60.0.0   BUSCTRL                                                           06/18/2021 17:32:19 PAGE 2   

  55          //  ------------------------------------
  56          
  57          
  58          // ===========================================================================
  59          //                      Parallel function description
  60          //==================================================================================
  61          //  
  62          //  
  63          //  
  64          
  65          void PCT_PageChange(U8 _pg)
  66          {
  67   1        U8 _dvc = 0;      //... temporal
  68   1        U8 _addr=0xFF;
  69   1      
  70   1        EA = OFF;   // Disable All Interrupt
  71   1        //... P[7:4]:INT[5:2], P1_3:HALE, P1_2:HRDB, P1_1:HWRB, P1_0:HSPB
  72   1        MCTRL = 0xf6;   //... initial state
  73   1        //if(_pg == DVC_PG0){ HCSB1=0;  HCSB0=0;}
  74   1        //else if(_pg == DVC_PG1){  HCSB1=0;  HCSB0=1;}
  75   1        //else if(_pg == DVC_PG2){  HCSB1=1;  HCSB0=0;}
  76   1        HCSB0=0;///1;
  77   1        HCSB1=0;///1;
  78   1      
  79   1        MDATA = _addr;
  80   1        HALE = 1; 
  81   1        HALE = 0;
  82   1        MDATA = _pg;
  83   1        HWRB = 0;       
  84   1        HWRB = 1;
  85   1      
  86   1        MCTRL = 0xf6;   //... initial state
  87   1        HCSB0=0;///1
  88   1        HCSB1=0;///1;
  89   1        MDATA = 0xff;
  90   1        EA = ON;    // Enable All Interrupt
  91   1      }
  92          
  93          void PCT_WriteAsicByte(U8 _dvc, U8 _pg, U8 _addr, U8 _wdat)
  94          {
  95   1        _dvc = 0;     //... temporal
  96   1      
  97   1        EA = OFF;   // Disable All Interrupt
  98   1        //... P[7:4]:INT[5:2], P1_3:HALE, P1_2:HRDB, P1_1:HWRB, P1_0:HSPB
  99   1      
 100   1        #if (TW2837==ON)
 101   1        PCT_PageChange(_pg);
 102   1        #endif
 103   1      
 104   1        MCTRL = 0xf6;   //... initial state
 105   1      #if (TW2837==ON) 
 106   1          HCSB0=0;///1;
 107   1          HCSB1=0;///1;
 108   1        
 109   1      #else
              
                if(_pg == DVC_PG0){ HCSB1=0;  HCSB0=0;}
                else if(_pg == DVC_PG1){  HCSB1=0;  HCSB0=1;}
                else if(_pg == DVC_PG2){  HCSB1=1;  HCSB0=0;}
              #endif  
 115   1        MDATA = _addr;
 116   1        HALE = 1; 
C51 COMPILER V9.60.0.0   BUSCTRL                                                           06/18/2021 17:32:19 PAGE 3   

 117   1        HALE = 0;
 118   1        MDATA = _wdat;
 119   1        HWRB = 0;       
 120   1        HWRB = 1;
 121   1      
 122   1        MCTRL = 0xf6;   //... initial state
 123   1      #if (TW2837==ON) 
 124   1        HCSB0=0;///1;
 125   1        HCSB1=0;///1;
 126   1      #else 
                HCSB0=1;
                HCSB1=1;
              #endif  
 130   1        MDATA = 0xff;
 131   1        EA = ON;    // Enable All Interrupt
 132   1      }
 133          
 134          //==================================================================================
 135          //  
 136          //  
 137          //  
 138          #if 1
 139          #define BDelay   1
 140          #define Delay_val 0
 141          
 142          extern U16 _delay;
 143          
 144          void PCT_WriteAsicTable(U8 _dvc, U8 _pg, U8 _addr, U8 *_tbl_ptr, U8 _tbl_cnt)
 145          {
 146   1        _dvc = 0;     //... temporal
 147   1      
 148   1        EA = OFF;   // Disable All Interrupt
 149   1        //... P[7:4]:INT[5:2], P1_3:HALE, P1_2:HRDB, P1_1:HWRB, P1_0:HSPB
 150   1        //MCTRL_set();///MCTRL = 0xf6;    //... initial state
 151   1      
 152   1        #if (TW2837==ON)
 153   1        PCT_PageChange(_pg);
 154   1        #endif
 155   1        
 156   1      #ifdef NED
                  MCTRL_set();
              #else
 159   1          MCTRL = 0xf6;   //... initial state
 160   1      #endif
 161   1      
 162   1      #if (TW2837==ON) 
 163   1          HCSB0=0;///1;
 164   1          HCSB1=0;///1;
 165   1        
 166   1      #else
              
                if(_pg == DVC_PG0){ HCSB1=0;  HCSB0=0;}
                else if(_pg == DVC_PG1){  HCSB1=0;  HCSB0=1;}
                else if(_pg == DVC_PG2){  HCSB1=1;  HCSB0=0;}
              #endif  
 172   1              #ifdef BDelay
 173   1                    //Wait_ms(Delay_val);//ryan..
 174   1                    DELAY_FOR(Delay_val); 
 175   1                              #endif
 176   1      
 177   1        do {
 178   2          MDATA = _addr++;
C51 COMPILER V9.60.0.0   BUSCTRL                                                           06/18/2021 17:32:19 PAGE 4   

 179   2          
 180   2          HALE = 1;
 181   2                                      #ifdef BDelay
 182   2                              //Wait_ms(Delay_val);//ryan..
 183   2                              DELAY_FOR(Delay_val); 
 184   2                              #endif
 185   2      
 186   2          HALE = 0;
 187   2        
 188   2          MDATA = *_tbl_ptr++;
 189   2          HWRB = 0;
 190   2                                      #ifdef BDelay
 191   2                              //Wait_ms(Delay_val);//ryan..
 192   2                              DELAY_FOR(Delay_val); 
 193   2                              #endif
 194   2      
 195   2          HWRB = 1;
 196   2        }while( --_tbl_cnt!=0 );
 197   1      
 198   1      //  MCTRL_set();///MCTRL = 0xf6;    //... initial state
 199   1      #ifdef NED
                  MCTRL_set();
              #else
 202   1          MCTRL = 0xf6;   //... initial state
 203   1      #endif
 204   1      #if (TW2837==ON) 
 205   1        HCSB0=0;///1;
 206   1        HCSB1=0;///1;
 207   1      #else 
                HCSB0=1;
                HCSB1=1;
              #endif  
 211   1        MDATA = 0xff;
 212   1      
 213   1        EA = ON;    // Enable All Interrupt
 214   1      }
 215          
 216          
 217          #else
              void PCT_WriteAsicTable(U8 _dvc, U8 _pg, U8 _addr, U8 *_tbl_ptr, U8 _tbl_cnt)
              {
                _dvc = 0;     //... temporal
              
                EA = OFF;   // Disable All Interrupt
                //... P[7:4]:INT[5:2], P1_3:HALE, P1_2:HRDB, P1_1:HWRB, P1_0:HSPB
                MCTRL = 0xf6;   //... initial state
              
                if(_pg == DVC_PG0){ HCSB1=0;  HCSB0=0;}
                else if(_pg == DVC_PG1){  HCSB1=0;  HCSB0=1;}
                else if(_pg == DVC_PG2){  HCSB1=1;  HCSB0=0;}
              
                do {
                  MDATA = _addr++;
                  HALE = 1;
                  HALE = 0;
                
                  MDATA = *_tbl_ptr++;
                  HWRB = 0;
                  HWRB = 1;
                }while( --_tbl_cnt!=0 );
              
                MCTRL = 0xf6;   //... initial state
C51 COMPILER V9.60.0.0   BUSCTRL                                                           06/18/2021 17:32:19 PAGE 5   

                HCSB0=1;
                HCSB1=1;
                MDATA = 0xff;
                EA = ON;    // Enable All Interrupt
              }
              #endif
 247          //==================================================================================
 248          //  
 249          //  
 250          //  
 251          U8 PCT_ReadAsicByte(U8 _dvc, U8 _pg, U8 _addr)
 252          {
 253   1        register U8 _rdat_;
 254   1      
 255   1        EA = OFF;   // Disable All Interrupt
 256   1        #if (TW2837==ON)
 257   1        PCT_PageChange(_pg);
 258   1        #endif
 259   1        
 260   1        //... P[7:4]:INT[5:2], P1_3:HALE, P1_2:HRDB, P1_1:HWRB, P1_0:HSPB
 261   1        MCTRL = 0xf6;   //... initial state
 262   1      
 263   1        _dvc = 0;     //... temporal
 264   1      #if (TW2837==ON) 
 265   1        HCSB0=0;//1;
 266   1        HCSB1=0;//1;
 267   1      
 268   1      #else
                if(_pg == DVC_PG0){ HCSB1=0; HCSB0=0;}
                else if(_pg == DVC_PG1){ HCSB1=0; HCSB0=1;}
                else if(_pg == DVC_PG2){ HCSB1=1; HCSB0=0;}
              #endif  
 273   1        MDATA = _addr;
 274   1        HALE = 1;
 275   1        HALE = 0;
 276   1        MDATA = 0xff;   // port0(MDATA) input mode
 277   1        HRDB = 0;
 278   1        _rdat_ = MDATA;
 279   1        HRDB = 1;
 280   1      
 281   1        MCTRL = 0xf6;   //... initial state
 282   1      #if (TW2837==ON) 
 283   1        HCSB0=0;///1;
 284   1        HCSB1=0;///1;
 285   1      #else 
                HCSB0=1;
                HCSB1=1;
              #endif  
 289   1        EA = ON;    // Enable All Interrupt
 290   1        return _rdat_;
 291   1      }
 292          
 293          
 294          //==================================================================================
 295          //  
 296          //  Write Register Address & Data form Table until address=0xFFFF then STOP
 297          //  
 298          void PCT_WriteSTable(U8 _dvc, WRITE_REG_DATA *_tbl_ptr)
 299          {
 300   1        #define PAGE GETHBYTE(_tbl_ptr->addr)
 301   1        #define ADDR GETLBYTE(_tbl_ptr->addr)
 302   1      
C51 COMPILER V9.60.0.0   BUSCTRL                                                           06/18/2021 17:32:19 PAGE 6   

 303   1        _dvc = 0;
 304   1        while( _tbl_ptr->addr!=0xFFFF ) {
 305   2            if(TW28_ReadByte(PAGE, ADDR) != _tbl_ptr->dat)//William @HS 2007 0829 Ver3.4
 306   2              {
 307   3          TW28_WriteByte(PAGE, ADDR, _tbl_ptr->dat);
 308   3              }
 309   2          _tbl_ptr++; 
 310   2        }
 311   1      }
 312          
 313          //==================================================================================
 314          //  
 315          // Change to I2C Control Mode
 316          //  
 317          void PTC_SwitchToI2CMode(void)
 318          {
 319   1      #ifdef TW28_I2CBUS
                HSPB  = 1;
                HALE  = 1;
                MDATA   = 0xFF; 
                HCSB0   = 0;
                HCSB1   = 0;
                HRDB  = 0;
                HWRB  = 0;
              #endif
 328   1      }
 329          
 330          void  SetAsicFlgType(U8 _dvc, U8 _pg, U8 _addr, U8 _flg, U8 _data)
 331          {
 332   1        U8 _t1_;
 333   1      
 334   1        _t1_ = PCT_ReadAsicByte(_dvc,_pg,_addr);
 335   1        _t1_ = (_t1_ & ~_flg)|_data;
 336   1        PCT_WriteAsicByte(_dvc,_pg,_addr,_t1_);
 337   1      }
 338          
 339          
 340          // ===========================================================================
 341          // END of File 
 342          // ===========================================================================
 343          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    385    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----      20
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
